<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulace ubytování</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..700;1,100..700&display=swap"
        rel="stylesheet">
    <link <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Reset and Base Styles */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 100%;
            /* 1rem = 16px */
        }

        body {
            font-family: 'Raleway', sans-serif;
            background-color: #ebebeb;
            color: #000;
            line-height: 1.5;
        }

        /* Typography */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            margin-bottom: 0.5rem;
            font-weight: 400;
        }

        h1 {
            font-size: 2rem;
        }

        .main-title {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .sub-heading {
            font-size: 1.125rem;
            font-weight: 700;
            letter-spacing: 1px;
            margin: 0.5rem 0;
        }

        .form-label {
            display: block;
            font-style: italic;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            color: #000;
        }

        /* Utility classes */
        .d-none {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-1 {
            margin-bottom: 0.25rem !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .btn-dark {
            display: block;
            margin: 1rem auto;
            padding: 0.625rem 1.25rem;
            font-size: 1rem;
            background-color: #343a40;
            border: 1px solid #343a40;
            color: #fff;
        }

        .btn-dark:focus {
            outline: none;
            box-shadow: none;
        }

        /* Layout Containers */
        .container-form {
            position: relative;
            max-width: 90%;
            margin: 1.25rem auto;
            padding: 2.5rem;
            background-color: #fff;
            border: 1px solid #ced4da;
        }

        .page {
            width: 210mm;
            height: 297mm;
            margin: 0 auto 1rem;
            padding: 1rem;
            background-color: #fff;
            border: 1px solid #ccc;
            box-sizing: border-box;
            position: relative;
        }

        .page .inner {
            height: 100%;
            position: relative;
        }

        .page-break {
            page-break-after: always;
        }

        /* Form Grid */
        .form-row-custom {
            display: grid;
            grid-template-columns: 0.25fr 0.65fr 0.25fr 0.4fr;
            gap: 0 0.3125rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .form-row-custom2 {
            display: grid;
            grid-template-columns: 0.3fr 0.7fr;
            gap: 0 0.3125rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .form-row-custom.full-width {
            grid-template-columns: 90px auto;
        }

        .col-label {
            text-align: left;

        }

        .col-value {
            padding-right: 0.3125rem;
        }

        .form-control,
        form-select,
        textarea {
            font-weight: 400;
            background-color: #fff;

            border-radius: 0;
            padding: 0.25rem 0.5rem;
            border: none;
            border-bottom: 1px solid #dee2e6;
        }

        #priceCalculatorA .form-control,
        #priceCalculatorA .form-select,
        #priceCalculatorA textarea {

            border-top: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
        }

        .form-control:focus,
        .form-select:focus {
            outline: none;
            box-shadow: none;
            border-color: #888;
        }

        .form-control[readonly],
        .form-control:disabled {
            background-color: #ffffff;
            opacity: 1;
            cursor: not-allowed;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th,
        td {
            padding: 0.5rem;
            text-align: left;
        }

        th {
            font-style: italic;
            font-weight: normal;
        }

        .bg-secondary {
            background-color: #6c757d !important;
        }

        .text-white {
            color: #fff !important;
        }

        /* Accordion */
        .accordion {
            border: none;
            border-radius: 0;
        }

        .accordion-item {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .accordion-button:focus {
            outline: none;
            box-shadow: none;
        }

        .accordion-button.bg-primary::after,
        .accordion-button.bg-success::after,
        .accordion-button.bg-dark::after,
        .accordion-button.bg-danger::after {
            filter: brightness(0) invert(1);
        }

        /* Tooltip */
        .tooltip-inner {
            max-width: 300px;
            white-space: pre-line;
            text-align: left;
        }

        .white-tooltip .tooltip-inner {
            background-color: #fff;
            color: #000;
            border: 1px solid #ccc;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
        }

        .white-tooltip .tooltip-arrow::before {
            border-color: #fff !important;
        }

        .custom-tooltip .tooltip-inner {
            background-color: violet;
            color: #fff;
        }

        /* Icons */
        .price-icon {
            font-size: 1.5rem;
            cursor: pointer;
            vertical-align: middle;
            line-height: 1;
            color: #0d6efd;
        }

        .holiday-info {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background-color: #0d6efd;
            color: #fff;
            text-align: center;
            line-height: 1.25rem;
            margin: 0 0.3125rem 0 0;
            cursor: pointer;
        }

        /* Header & Footer */
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ccc;
            color: #888;
        }

        .form-header img {
            max-width: 140px;
            height: auto;
        }

        .form-footer {
            position: absolute;
            bottom: 1rem;
            width: 90%;
        }

        /* skryjeme číselné pole Volné postele */
        #freeBeds {
            display: none !important;
        }

        /* společné stylování políček */
        .bed-rect {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            vertical-align: middle;
        }

        /* obsazené postele = modré */
        .bed-rect.occupied {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        /* neobsazené postele = průhledné */
        .bed-rect.free {
            background: transparent;
        }

        /* přistýlky = žluté */
        .bed-rect.extra {
            background-color: #ffc107;
            border-color: #ffc107;

        }

        .bed-icon {
            font-size: 1.5rem;
            vertical-align: middle;
            margin-right: 0.2rem;
            /* obsazené lůžko = modrá barva */
            color: #0d6efd;
        }

        .bed-icon.empty {
            /* prázdné lůžko/přistýlka = šedá */
            color: #ccc;
        }

        /* 1) extra přistýlka bude žlutá */
        .bed-icon.extra {
            color: #ffc107;
        }

        /* 4) odsazení selectu, aby se pod ikonu nevešel šipkový dropdown */
        .input-group .form-select {
            padding-right: 2.5rem;
        }
    </style>
</head>

<body>
    <div class="container-fluid mx-auto m-4   ">
        <div class="accordion" id="accordionExample">
            <div class="accordion-item shadow-sm">
                <div id="collapseOne" class="accordion-collapse collapse show">
                    <div class="accordion-body">
                        <h2>Volba ubytování</h2>

                        <form id="priceCalculatorA" class="row gy-2 gx-3 align-items-center">


                            <div class="col-auto">

                                <label for="daterange" class="form-label small">
                                    Termín</label>
                                <div class="input-group">

                                    <div class="input-group-text">

                                        <span class="material-symbols-outlined d-inline-block">calendar_month</span>
                                    </div>

                                    <input type="text" id="daterange" class="form-control "
                                        value="30.12.2024 - 02.01.2025">
                                </div>
                            </div>
                            <div class="col-auto">
                                <label for="apartmentSelect" class="form-label ">
                                    Apartmán</label>
                                <div class="input-group">

                                    <div class="input-group-text">
                                        <span class="material-symbols-outlined">apartment</span>
                                    </div>
                                    <select id="apartmentSelect" class="form-select form-select-sm">
                                        <option value="A" selected>A</option>
                                        <option value="B">B</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-auto">
                                <label for="peopleA" class="form-label ">
                                    Počet osob</label>
                                <div class="input-group">

                                    <div class="input-group-text">
                                        <span class="material-symbols-outlined">people</span>
                                    </div>
                                    <select id="peopleA" class="form-select form-select-sm">
                                        <option>1</option>
                                        <option>2</option>
                                        <option>3</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-auto">
                                <div class="input-group">

                                    <input type="text" id="freeBeds" class="form-control form-control-sm" readonly
                                        disabled>
                                </div>
                            </div>
                            <!-- 2. sloupec: Obsazené / Volné -->

                            <div class="col-auto">
                                <label for="petsA" class="form-label small text-bold">
                                    Psi</label>
                                <div class="input-group">

                                    <div class="input-group-text">
                                        <span class="material-symbols-outlined">pets</span>
                                    </div>

                                    <select id="petsA" class="form-select form-select-sm">
                                        <option>0</option>
                                        <option>1</option>
                                        <option>2</option>
                                        <option>3</option>
                                        <option>4</option>
                                        <option>5</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-auto"> 

                                <label for="petsA" class="form-label small text-bold">
                                    Ceník</label>
                                    <button type="button" class="btn btn-success btn-sm mt-auto w-100"
                                        data-bs-toggle="modal" data-bs-target="#priceModal" title="Ceník ubytování">
                                        <i class="material-icons align-middle">credit_card</i>

                                    </button>
                               </div>   
                        </form>
                        <div class="row">
                            <div>

                                <div class="beds-line" id="bedsLine"></div>
                                <div class="beds-line" id="extraBedsLine"></div>

                                <div class="beds-summary" id="bedsSummary"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item  shadow-sm  ">
                <div id="collapseTwo" class="accordion-collapse show">
                    <div class="accordion-body">
                        <h2>Výsledky kalkulace</h2>

                        <div id="result"></div>
                    </div>
                </div>
            </div>

        </div>
        <form id="reservationForm" data-date-range=" " data-apartment="" data-total-price="">


            <div id="reservationFormPage">
                <div class="row">
                    <div class="col">
                        <button type="submit" class="btn btn-dark mx-auto">PDF 1</button>
                        <div class="page page-1" id="page-1">


                            <div class="inner">
                                <div class="form-header">
                                    Krystoma s.r.o., Moravská Huzová 80, 783 13 Štěpánov, +420 604 471 323
                                    <img src="images/black.png" alt="Selský Dvůr Logo" width="100px">
                                </div>

                                <div class="main-title">ZÁVAZNÁ OBJEDNÁVKA UBYTOVÁNÍ</div>
                                <div class="form-section">

                                    <div class="form-section">
                                        <div class="form-row-custom2">
                                            <label class="form-label col-label">Číslo objednávky</label>
                                            <div class="col-value">
                                                <input name="orderNumber" class="form-control" id="orderNumber"
                                                    type="text"></input>
                                            </div>
                                        </div>
                                        <div class="form-row-custom2">
                                            <label class="form-label col-label">Termín</label>
                                            <div class="col-value">
                                                <input name="termSummary" class="form-control readonly" readonly>
                                            </div>



                                        </div>
                                        <div class="form-row-custom2">
                                            <label class="form-label col-label">Apartmán</label>
                                            <div class="col-value">
                                                <input name="apartmentInfo" class="form-control readonly" disabled
                                                    id="apartmentInfo" type="text"></input>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="sub-heading">Zákazník</div>
                                    <div class="form-section">

                                        <div class="form-row-custom">

                                            <label class="form-label col-label">Jméno</label>
                                            <div class="col-value"><input name="firstName" class="form-control"
                                                    required>
                                            </div>
                                            <label class="form-label col-label">Příjmení</label>
                                            <div class="col-value"><input name="lastName" class="form-control" required>

                                            </div>
                                        </div>
                                        <div class="form-row-custom">
                                            <label class="form-label col-label">Adresa</label>
                                            <div class="col-value"><input name="address" class="form-control" required>
                                            </div>
                                            <label class="form-label col-label">IČ/DIČ</label>
                                            <div class="col-value"><input name="companyId" class="form-control">
                                            </div>
                                        </div>
                                        <div class="form-row-custom">
                                            <label class="form-label col-label">Email</label>
                                            <div class="col-value"><input name="email" class="form-control" type="email"
                                                    required>
                                            </div>
                                            <label class="form-label col-label">Telefon</label>
                                            <div class="col-value"><input name="phone" class="form-control" required>
                                            </div>
                                        </div>
                                        <div class="form-row-custom">
                                            <label class="form-label col-label">Účel pobytu</label>
                                            <div class="col-value">
                                                <select name="purpose" class="form-select">
                                                    <option>Rekreace</option>
                                                    <option>Pracovní pobyt</option>
                                                    <option>Rekreace a součástí oslava</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-row-custom">
                                            <label class="form-label col-label">Způsob platby</label>
                                            <div class="col-value">
                                                <select name="payment" class="form-select d-block">
                                                    <option>zálohová faktura + doplatek na místě</option>
                                                    <option>celá částka předem</option>
                                                </select>
                                            </div>

                                        </div>

                                    </div>
                                </div>
                                <div class="sub-heading">Počet ubytovaných</div>
                                <div class="form-section">
                                    <div class="form-row-custom">
                                        <label class="form-label col-label">Muži</label>
                                        <div class="col-value"><input name="men" type="number" min="0"
                                                class="form-control" value="0">
                                        </div>
                                        <label class="form-label col-label">Děti (uveď věk)</label>
                                        <div class="col-value">
                                            <input name="children" type="text" class="form-control">
                                        </div>
                                    </div>
                                    <div class="form-row-custom">
                                        <label class="form-label col-label">Ženy</label>
                                        <div class="col-value"><input name="women" type="number" min="0"
                                                class="form-control" value="0">
                                        </div>
                                        <label class="form-label col-label">Psi</label>
                                        <div class="col-value"><input name="dogs" type="number" min="0"
                                                class="form-control" value="0">

                                        </div>
                                    </div>
                                </div>
                                <div class="sub-heading">Poznámka</div>

                                <div class="form-section">
                                    <div class="form-row-custom w-100">

                                        <div class="col-value ">
                                            <textarea name="note" class="form-control"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="sub-heading">Rekapitulace</div>

                                <div class="form-section">
                                    <div class="form-row-custom ">
                                        <label class="form-label col-label">Cena objednávky</label>
                                        <div class="col-value">
                                            <input name="priceSummary" class="form-control readonly" readonly>
                                        </div>
                                    </div>
                                    <div class="form-row-custom ">
                                        <label for="confirmationDate" class="form-label col-label">Objednáno
                                            dne</label>
                                        <div class="col-value">
                                            <input type="text" name="confirmationDate" class="form-control readonly"
                                                id="confirmationDate" required>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-dark mx-auto" id="generatePage2">PDF 2</button>

                        <div class="page page-2" id="page-2">

                            <div class="inner">
                                <div class="form-header">
                                    Krystoma s.r.o., Moravská Huzová 80, 783 13 Štěpánov, +420 604 471 323
                                    <img src="images/black.png" alt="Selský Dvůr Logo" width="100px">
                                </div>

                                <div class="sub-heading">Detailní kalkulace</div>
                                <div id="resultDetail"></div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </form>
        <!-- Modal for Price Table -->
        <div class="modal fade" id="priceModal" tabindex="-1" aria-labelledby="priceModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="priceModalLabel">Ceník ubytovaní</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="priceTableContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"
        integrity="sha384-7qAoOXltbVP82dhxHAUje59V5r2YsVfBafyUDxEdApLPmcdhBPg1DKg1ERo0BZlK"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <!-- Nejdřív fontkit -->
    <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.js"></script> <!-- Pak pdf-lib -->
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script>
        // script.js

        // ----- Data -----
        const holidays = [
            { date: "01-01", title: "Den obnovy samostatného českého státu" },
            { date: "05-08", title: "Den vítězství" },
            { date: "07-05", title: "Den slovanských věrozvěstů Cyrila a Metoděje" },
            { date: "07-06", title: "Den upálení mistra Jana Husa" },
            { date: "09-28", title: "Den české státnosti" },
            { date: "10-28", title: "Den vzniku samostatného československého státu" },
            { date: "11-17", title: "Den boje za svobodu a demokracii" },
            { date: "04-04", title: "Velký pátek" },
            { date: "04-05", title: "Velikonoční pondělí" },
            { date: "05-01", title: "Svátek práce" }
        ];
        // 1) Nejprve si externě definujte společnou funkci pro přepočet:
        function recalc() {
            calculatePrice();
            fillReservationFormData();
        }


        // ----- Init -----
        document.addEventListener('DOMContentLoaded', init);
        function init() {
            renderPriceTable();
            initTooltips();
            initDateRangePicker();
            initApartmentPeople();
            recalc();
            // 2) Napojte ji na všechny inputy/selecty ve formuláři:
            ['change', 'input'].forEach(evt => {
                document
                    .querySelectorAll('#priceCalculatorA input, #priceCalculatorA select')
                    .forEach(el => el.addEventListener(evt, recalc));
            });

            // 3) A přidejte ho i na apply udalost daterangepickeru:
            $('#daterange').on('apply.daterangepicker', recalc);
            document
                .getElementById('reservationForm')
                .addEventListener('submit', e => onReservationSubmit(e, 1));

            // Nové tlačítko → stránka 2
            document
                .getElementById('generatePage2')
                .addEventListener('click', e => onReservationSubmit(e, 2));
        }
        // po init()


        // místo původní funkce
        function getSilvesterDates() {
            const year = new Date().getFullYear();
            const start = new Date(year, 11, 30);    // 30. 12.
            const end = new Date(year + 1, 0, 2); // 02. 01. následujícího roku
            const dates = [];
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const full = `${day}.${month}.${d.getFullYear()}`;
                dates.push(full);
            }
            return dates.join('\n');
        }

        function renderPriceTable() {
            const container = document.getElementById('priceTableContainer');
            container.innerHTML = '';


            const colA = createTable(
                ["Ubytovací noc", "Cena", "Minimální počet nocí"],
                [
                    [`<span class="holiday-info" data-bs-toggle="tooltip" data-bs-custom-class="custom-tooltip" title="Noc neděle až čtvrtek">i</span> Všední den`, "550 CZK", "2"],
                    [`<span class="holiday-info" data-bs-toggle="tooltip" data-bs-custom-class="custom-tooltip" title="páteční a sobotní noc">i</span> Víkendová noc`, "650 CZK", "2"],
                    [`<span class="holiday-info" data-bs-toggle="tooltip" data-bs-custom-class="custom-tooltip" title="${getHolidayDates().replace(/"/g, '&quot;')}">i</span> Sváteční noc`, "650 CZK", "2"],
                    [`<span class="holiday-info" data-bs-toggle="tooltip" data-bs-custom-class="custom-tooltip" title="${getSilvesterDates()}">i</span> Silvestr`, "650 CZK", "4"]
                ]
            );
            container.appendChild(colA);

            // Tabulka B – příplatky
            const titleB = document.createElement('h5');
            titleB.textContent = 'Příplatky';
            titleB.classList.add('mt-4');  // trochu mezery od předchozí tabulky
            container.appendChild(titleB);

            const colB = createTable(
                ["Příplatek", "Cena"],
                [
                    ["Pouze 1 noc", "+30%"],
                    ["Neobsazená postel", "300 CZK"],
                    ["Pes (za den)", "300 CZK"]
                ]
            );
            container.appendChild(colB);

            // znovu inicializovat tooltipy
            initTooltips();
        }

        function createTable(headers, rows) {
            const table = document.createElement('table');
            table.className = 'table';
            const thead = document.createElement('thead');
            thead.className = '';
            thead.innerHTML = `<tr>${headers.map(h => `<th class="">${h}</th>`).join('')}</tr>`;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            rows.forEach(r => {
                const tr = document.createElement('tr');
                r.forEach(c => {
                    const td = document.createElement('td');
                    td.innerHTML = c;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            return table;
        }

        function getHolidayDates() {
            return holidays.map(h => {
                const [m, d] = h.date.split('-');
                return `${d}.${m}. – ${h.title}`;
            }).join('\n');
        }

        function initTooltips() {
            document.querySelectorAll('[data-bs-toggle="tooltip"]')
                .forEach(el => new bootstrap.Tooltip(el));
        }

        // ----- DateRangePicker -----
        function initDateRangePicker() {
            const $dr = $('#daterange');
            const today = new Date();
            const start = new Date(today); start.setDate(start.getDate() + 1);
            const end = new Date(start); end.setDate(end.getDate() + 3);
            const fmt = d => `${String(d.getDate()).padStart(2, '0')}.` +
                `${String(d.getMonth() + 1).padStart(2, '0')}.` +
                `${d.getFullYear()}`;
            $dr.daterangepicker({
                autoApply: true,
                locale: {
                    format: 'DD.MM.YYYY', separator: ' - ',
                    applyLabel: 'Aplikovat', cancelLabel: 'Zrušit',
                    daysOfWeek: ["Ne", "Po", "Út", "St", "Čt", "Pá", "So"],
                    monthNames: ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"],
                    firstDay: 1
                },
                startDate: fmt(start),
                endDate: fmt(end),
                drops: 'down'
            }, (s, e) => $('#nights').val(e.diff(s, 'days')));
            $('#nights').val((end - start) / (1000 * 60 * 60 * 24));
        }

        // ----- Kapacita a volná lůžka -----
        function initApartmentPeople() {
            const apt = document.getElementById('apartmentSelect');
            const ppl = document.getElementById('peopleA');
            apt.addEventListener('change', onApartmentChange);
            document
                .querySelectorAll('#apartmentSelect, #peopleA')
                .forEach(el => el.addEventListener('change', updateFreeBeds));

            onApartmentChange();
            updateFreeBeds();
        } function updateFreeBeds() {
            const aptVal = document.getElementById('apartmentSelect').value;
            const maxBeds = aptVal === 'A' ? 18 : 8;
            const cap = aptVal === 'A' ? 11 : 6;
            const used = +document.getElementById('peopleA').value;
            const filledBeds = Math.min(used, cap);
            const freeBeds = cap - filledBeds;
            const extrasTotal = maxBeds - cap;
            const extrasUsed = Math.max(used - cap, 0);
            const extrasFree = extrasTotal - extrasUsed;

            document.getElementById('freeBeds').value = freeBeds;

            document.getElementById('bedsLine').innerHTML =
                '<span class="material-symbols-outlined bed-icon">person</span>'.repeat(filledBeds) +
                '<span class="material-symbols-outlined bed-icon empty">person</span>'.repeat(freeBeds);

            document.getElementById('extraBedsLine').innerHTML =
                '<span class="material-symbols-outlined bed-icon extra">person</span>'.repeat(extrasUsed) +
                '<span class="material-symbols-outlined bed-icon empty">person</span>'.repeat(extrasFree);

            let summary = `Využito: ${filledBeds} / ${cap} postelí`;
            if (extrasTotal > 0) {
                summary += `, ${extrasUsed} / ${extrasTotal} přistýlek`;
            }
            document.getElementById('bedsSummary').textContent = summary;
        }



        function onApartmentChange() {
            const aptVal = document.getElementById('apartmentSelect').value;
            const max = aptVal === 'A' ? 18 : 8;
            const cap = aptVal === 'A' ? 11 : 6;
            // v onApartmentChange() místo textContent pro capacityDisplay:
            const capDisp = document.getElementById('capacityDisplay');

            const pplSelect = document.getElementById('peopleA');
            pplSelect.innerHTML = '';
            for (let i = 1; i <= max; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = i;
                pplSelect.appendChild(opt);
            }
            updateFreeBeds();
        }






        function calculate() {
            calculatePrice();
            fillReservationFormData();
        }

        function calculatePrice() {
            // --- načtení vstupních hodnot ---
            const dateRange = $('#daterange').val().split(' - ');
            const dateFrom = new Date(dateRange[0].split('.').reverse().join('-'));
            const dateTo = new Date(dateRange[1].split('.').reverse().join('-'));
            let people = parseInt($('#peopleA').val(), 10);
            const pets = parseInt($('#petsA').val(), 10);
            const diffTime = dateTo - dateFrom;
            const diffNights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffTime <= 0) { alert('Datum odjezdu nesprávné'); return; }
            if (diffNights < 1) { alert('Min. počet nocí je 1.'); return; }

            // --- cenové konstanty ---
            const apt = $('#apartmentSelect').val();
            const capacity = apt === 'A' ? 11 : 6;
              const showFreeBedsColumn = people < capacity;

            const showPetColumn = pets > 0;
            const standardPrice = 550;
            const weekendPrice = 650;
            const unusedBedPrice = 300;
            const holidayPrice = 650;
            const silvestrPrice = 650;
            const petPrice = 300;

            // --- Silvestr detekce ---
            const isSilvestr = dateFrom <= new Date(dateFrom.getFullYear(), 11, 31)
                && dateTo >= new Date(dateFrom.getFullYear(), 11, 31);
            let silvestrNights = 0;

            // --- ikony pro typ ceny ---
            const iconMap = {
                'Všední noc': 'bed',
                'Víkendová noc': 'weekend',
                'Svátek': 'event',
                'Silvestrovská noc': 'celebration'
            };

            let totalPrice = 0;

            // --- hlavička tabulky ---
            let breakdown = `
        <table class="table">
        <thead>
            <tr>
            <th>Ubytovací noc</th> 
            <th>Obsazené postele</th>
          ${showFreeBedsColumn ? '<th>Neobsazené postele</th>' : ''}
            ${showPetColumn ? '<th>Pes</th>' : ''}
            ${diffNights === 1 ? '<th>Příplatek 30 %</th>' : ''}
            <th>Celkem za noc</th>
            </tr>
        </thead>
        <tbody>
    `;

            for (let d = new Date(dateFrom); d < dateTo; d.setDate(d.getDate() + 1)) {
                const day = new Date(d);
                const dateStr = `${String(day.getDate()).padStart(2, '0')}.` +
                    `${String(day.getMonth() + 1).padStart(2, '0')}.${day.getFullYear()}`;
                const weekday = day.toLocaleDateString('cs-CZ', { weekday: 'long' });
                const isHolidayDay = holidays.find(h =>
                    h.date === `${String(day.getMonth() + 1).padStart(2, '0')}-${String(day.getDate()).padStart(2, '0')}`
                );
                const isWeekendDay = [5, 6].includes(day.getDay());

                // 1) typ ceny a cena obsazených lůžek
                let priceType, occupiedBedsPrice;
                if (isSilvestr && silvestrNights < 4) {
                    priceType = 'Silvestrovská noc';
                    occupiedBedsPrice = silvestrPrice * people;
                    silvestrNights++;
                } else if (isHolidayDay) {
                    priceType = `Sváteční noc:: ${isHolidayDay.title}`;
                    occupiedBedsPrice = holidayPrice * people;
                } else if (isWeekendDay) {
                    priceType = 'Víkendová noc';
                    occupiedBedsPrice = weekendPrice * people;
                } else {
                    priceType = 'Všední noc';
                    occupiedBedsPrice = standardPrice * people;
                }

                // 2) neobsazená lůžka
                const unoccBeds = Math.max(capacity - people, 0);
                const unoccBedsPrice = unusedBedPrice * unoccBeds;

                // 3) poplatek za psa
                const petCharge = pets > 0 ? pets * petPrice : 0;

                // 4) případný příplatek za jednu noc
                let dayPrice = occupiedBedsPrice + unoccBedsPrice + petCharge;
                let surcharge = 0;
                if (diffNights === 1) {
                    surcharge = dayPrice * 0.3;
                    dayPrice += surcharge;
                }
                // buňka Typ ceny jako piktogram s tooltipem
                const ico = iconMap[priceType.split(':')[0]] || 'paid';


                // buňka Datum s tooltipem (den + svátek/Silvestr)
                const dateTooltip = isHolidayDay
                    ? `${weekday}, Svátek: ${isHolidayDay.title}`
                    : (priceType.startsWith('Silvestrovská noc') ? `${weekday}, Silvestr` : weekday);
                const dateCell = `
      <td>
        <span data-bs-toggle="tooltip" data-bs-custom-class="white-tooltip" class="material-symbols-outlined price-icon" title="${priceType.split(':')[0]} ">${ico} </span>
        <span data-bs-toggle="tooltip"
              data-bs-custom-class="white-tooltip"
              title="${dateTooltip}">
           
          ${dateStr}
        </span>
      </td>`;



                // buňka Obsazené postele: počet, tooltip=rozpis výpočtu
                const occupiedTooltip = `${people} × ${(occupiedBedsPrice / people).toLocaleString()} = ${occupiedBedsPrice.toLocaleString()} CZK`;
                const perBed = (occupiedBedsPrice / people).toLocaleString();
                const occupiedCell = `
  <td>
    <span data-bs-toggle="tooltip"
          data-bs-custom-class="white-tooltip"
          title="${people} × ${perBed} CZK = ${occupiedBedsPrice.toLocaleString()} CZK">
      ${people} × ${perBed}
    </span>
  </td>`;


                // buňka Neobsazené postele: počet, tooltip=rozpis výpočtu
                const unoccTooltip = `${unoccBeds} × ${unusedBedPrice} = ${unoccBedsPrice.toLocaleString()} CZK`;
              const unoccupiedCell = showFreeBedsColumn
      ? `<td>
           <span data-bs-toggle="tooltip" title="${unoccBeds} × ${unusedBedPrice} = ${unoccBedsPrice} CZK">
             ${unoccBeds} × ${unusedBedPrice}
           </span>
         </td>`
      : '';
                const petCell = showPetColumn ? `
      <td>
        <span data-bs-toggle="tooltip"
              data-bs-custom-class="white-tooltip"
              title="${pets} × ${petPrice} = ${petCharge.toLocaleString()} CZK">
          ${pets} x ${petPrice}
        </span>
      </td>` : '';

                // buňka Pes a případný příplatek 30%

                const surchargeCell = diffNights === 1 ? `<td>${surcharge.toLocaleString()} CZK</td>` : '';

                // buňka Za noc: číslo + tooltip detail
                let parts = [];
                parts.push(`Obsazené: ${occupiedTooltip}`);
                if (unoccBeds > 0) parts.push(`Neobsazené: ${unoccTooltip}`);
                if (petCharge) parts.push(`Pes: ${petCharge.toLocaleString()} CZK`);
                if (surcharge) parts.push(`Příplatek: ${surcharge.toLocaleString()} CZK`);
                const totalTooltip = parts.join('\n');
                const totalCell = `
      <td>
        <span data-bs-toggle="tooltip"
              data-bs-custom-class="white-tooltip"
              title="${totalTooltip}">
          ${dayPrice.toLocaleString()} CZK
        </span>
      </td>`;

                // sestavíme řádek
                breakdown += `
      <tr>
        
        ${dateCell}
        ${occupiedCell}
        ${unoccupiedCell}
        ${petCell}
        ${surchargeCell}
        ${totalCell}
      </tr>`;

                totalPrice += dayPrice;
            }

       // finální řádek – správně dopočítat colspan
  const staticCols = 2; // datum + obsazené
  const colspan = staticCols
                + (showFreeBedsColumn ? 1 : 0)
                + (showPetColumn      ? 1 : 0)
                + (diffNights === 1   ? 1 : 0);
  breakdown += `
      <tr class="bg-secondary text-white">
        <td colspan="${colspan}">
          <strong>Celkem</strong>
        </td>
        <td class="totalprice">${totalPrice.toLocaleString()} CZK</td>
      </tr>
    </tbody>
  </table>`;
            $('#result').html(breakdown).show();

            $('#resultDetail').html(breakdown);
            initTooltips();
            fillReservationFormData();
        }

        function fillReservationFormData() {
            const form = document.getElementById('reservationForm');
            const dr = $('#daterange').val();
            const apt = $('#apartmentSelect').val();
            const ppl = +$('#peopleA').val();
            const pets = +$('#petsA').val();
            const orderNumber = $('#orderNumber').val();

            const priceText = $('#result .totalprice').first().text().trim();
            const price = priceText.replace('Celková cena: ', '');

            form.dataset.dateRange = dr;
            form.dataset.apartment = apt;
            form.dataset.totalPrice = price;
            form.dataset.orderNumber = orderNumber;

            form.termSummary.value = dr;
            form.men.value = Math.floor(ppl / 2);
            form.women.value = ppl - Math.floor(ppl / 2);
            form.dogs.value = pets;
            document.getElementById('apartmentInfo').value = 'Apartmán ' + apt;
            form.elements['priceSummary'].value = price;


        }

        async function onReservationSubmit(e, pageNo = 1) {
            e.preventDefault();

            // 1) Naplníme data
            fillReservationFormData();

            // 2) Název souboru
            const orderNum = document
                .getElementById('orderNumber')
                .value
                .trim() || 'objednavka';

            // 3) Hledáme element .inner uvnitř #page-X
            const pageEl = document.getElementById(`page-${pageNo}`);
            if (!pageEl) {
                alert(`Strana ${pageNo} neexistuje!`);
                return;
            }
            const innerEl = pageEl.querySelector('.inner');
            if (!innerEl) {
                alert(`Strana ${pageNo} nemá element .inner`);
                return;
            }

            // 4) Připravíme název souboru
            const filename = pageNo === 2
                ? `${orderNum}_strana2.pdf`
                : `${orderNum}.pdf`;

            // 5) Nastavíme relative kontejner pro footer
            innerEl.style.position = 'relative';

            // 6) Vložíme upravující <style> jen jednou, na .inner
            const styleTag = document.createElement('style');
            styleTag.textContent = `
    .form-control,
    .form-select,
    textarea {
      border: none !important;
      border-bottom: 1px solid #ced4da !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }
    .form-control[readonly],
    .form-control[disabled] {
      background-color: #fff !important;
    }
   .form-footer {
            margin-top: auto;
            position: absolute !important;
            bottom: 1rem;
            width: 90%;
        }

  `;
            innerEl.insertBefore(styleTag, innerEl.firstChild);

            // 7) Nastavení html2pdf
            const opt = {
                margin: [15, 15, 15, 15],
                filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
            };

            // 8) Generování PDF jen z .inner
            html2pdf()
                .set(opt)
                .from(innerEl)
                .save();
        }

        // --- Uložení formuláře do localStorage ---
        function saveFormToLocalStorage() {
            const form = document.getElementById('reservationForm');
            const data = {};
            Array.from(form.elements).forEach(el => {
                if (el.name) {
                    if (el.type === "checkbox" || el.type === "radio") {
                        data[el.name] = el.checked;
                    } else {
                        data[el.name] = el.value;
                    }
                }
            });
            localStorage.setItem('reservationFormData', JSON.stringify(data));
        }

        // --- Obnovení formuláře z localStorage ---
        function loadFormFromLocalStorage() {
            const form = document.getElementById('reservationForm');
            const data = JSON.parse(localStorage.getItem('reservationFormData') || '{}');
            Object.entries(data).forEach(([key, value]) => {
                const el = form.elements[key];
                if (el) {
                    if (el.type === "checkbox" || el.type === "radio") {
                        el.checked = value;
                    } else {
                        el.value = value;
                    }
                }
            });
        }

        // --- Přidejte event listenery ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFormFromLocalStorage();
            const form = document.getElementById('reservationForm');
            if (form) {
                form.addEventListener('input', saveFormToLocalStorage);
            }
        });
    </script>
</body>

</html>