<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalkulace ubytování</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* Barvy a typografie */
    :root {
      --primary: #0d6efd;
      --muted: #adb5bd;
      --text: #212529;
    }

    body {
      background: #e9ecef;
      color: var(--text);
      font-family: 'Roboto', sans-serif;
    }

    h1,
    .card-title {
      font-weight: 600;
      color: var(--text);
    }

    /* Karty a formulář */
    .card {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: .5rem;
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: flex;
      align-items: center;
      font-weight: 500;
      color: #495057;
    }

    .form-label i {
      margin-right: .5rem;
    }

    .form-check-input {
      accent-color: var(--primary);
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 .25rem rgba(133, 67, 3, 0.25);
    }

    .text-muted {
      color: #6c757d !important;
    }

    /* Rekapitulace */
    .recap-table th,
    .recap-table td {
      border-top: none;
      color: var(--text);
    }

    .recap-table th {
      font-weight: 500;
      color: #343a40;
    }

    #totalPrice {
      color: #dc3545;
      font-weight: 600;
    }

    /* Datepicker */
    .daterangepicker td.off {
      visibility: hidden;
      /* Skrytí obsahu, zachová strukturu mřížky */
    }

    .daterangepicker td.available.weekend {}

    .daterangepicker td.available.holiday {}

    /* Pouze vybrané dny (první a poslední) */
    .daterangepicker td.available.active {
      background-color: var(--primary) !important;
      border-color: var(--primary) !important;
      color: #fff !important;
    }

    /* Odstranění stylu pro in-range, aby se neobarvoval celý interval */
    .daterangepicker td.in-range {
      background: #1a1a1a0f !important;
      color: var(--text) !important;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="row gy-3">
      <!-- Formulář výběru -->
      <div class="col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body">

            <div class="mb-3 d-inline">
              <div class="row">
                <div class="col-md-6">
                  <label class="form-label">Datum příjezdu - Datum odjezdu</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="material-icons">calendar_month</i></span>
                    <input type="text" id="daterange" class="form-control" readonly>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label"><span class="ms-2" id="capacityDisplay">11+5</span>
</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="material-icons">apartment</i></span>
                    <select id="apartmentSelect" class="form-select">
                      <option value="A">Apartmán A</option>
                      <option value="B">Apartmán B</option>
                      <option value="AB">Celý objekt</option>
                    </select>
                  </div>
                </div>


              </div>
              <!-- Původní radio blok nahraďte tímto -->
              <div class="mb-3 mt-3">

              </div> 
            </div>
            <div class="row mt-3">
              <div class="col-3 mb-3">
                <label class="form-label">Dospělí</label>

                <div class="input-group">
                  <span class="input-group-text"><i class="material-icons">people</i></span>
                  <select id="adultCount" class="form-select"></select>
                </div>

              </div>
              <div class="col-3 mb-3">
                <label class="form-label">Děti od 3 let</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="material-icons">child_care</i></span>
                  <select id="childCount" class="form-select"></select>

                </div>

              </div>
              <div class="col-3 mb-3">
                <label class="form-label">Děti do 2,99 let</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="material-icons">child_friendly</i></span>
                  <select id="toddlerCount" class="form-select">
                    <!-- možnosti se budou plnit JS -->
                  </select>
                </div>
              </div>

              <div class="col-3 mb-3">
                <label class="form-label">Mazlíčci</label>

                <div class="input-group">
                  <span class="input-group-text"><i class="material-icons">pets</i></span>

                  <select id="petsCount" class="form-select">
                    <option>0</option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>

                  </select>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Rekapitulace -->
      <div class="col-lg-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Cenová nabídka</h5>
            <table class="table recap-table">
              <tbody>

                <tr>
                  <th scope="row">Datum příjezdu - Datum odjezdu</th>
                  <td class="text-end" id="sumTerm">–</td>
                </tr>
                <tr>

                  <th scope="row">Nocí</th>
                  <td class="text-end" id="sumNights">–</td>
                </tr>
                <tr>
                  <th scope="row">Apartmán</th>
                  <td class="text-end" id="sumApartment">–</td>
                </tr>
                <tr>
                  <th scope="row" class="">Dospělí</th>
                  <td class="text-end" id="sumAdults">–</td>
                </tr>
                <tr>
                  <th scope="row" class="">Děti od 3 let</th>
                  <td class="text-end" id="sumChildren">–</td>
                </tr>
                <tr>
                  <th scope="row" class="">Děti do 2,99 let</th>
                  <td class="text-end" id="sumToddlers">–</td>
                </tr>

                <tr>
                  <th scope="row">Mazlíčci</th>
                  <td class="text-end" id="sumPets">–</td>
                </tr>
              </tbody>
            </table>
            <h4 class="text-end">Cena pobytu: <span id="totalPrice">0 CZK</span></h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Skripty -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.min.js"></script>
  <script>
    $(function () {
      const holidays = ['01-01', '05-08', '07-05', '07-06', '09-28', '10-28', '11-17', '04-04', '04-05', '05-01'];

      // Daterangepicker
      $('#daterange').daterangepicker({
        locale: {
          format: 'DD.MM.YYYY', separator: ' - ',
          daysOfWeek: ['Ne', 'Po', 'Út', 'St', 'Čt', 'Pá', 'So'],
          monthNames: ['Leden', 'Únor', 'Březen', 'Duben', 'Květen', 'Červen', 'Červenec', 'Srpen', 'Září', 'Říjen', 'Listopad', 'Prosinec'],
          firstDay: 1, applyLabel: 'Aplikovat', cancelLabel: 'Zrušit'
        },
        startDate: moment().add(1, 'days'),
        endDate: moment().add(3, 'days'),
        isCustomDate: function (date) {
          const wd = date.day();
          // pouze pátek (5) a sobota (6)
          if (wd === 6 || wd === 7) return 'weekend';
          if (holidays.includes(date.format('MM-DD'))) return 'holiday';
          return '';
        }
      });

      // Aktivní label
      $('label[for="daterange"]').addClass('active');
      $('#daterange').on('apply.daterangepicker', function () {
        $('label[for="daterange"]').addClass('active');
      });

      // Tooltip pro svátky
      $('#daterange').on('show.daterangepicker', (ev, picker) => {
        setTimeout(() => {
          picker.container.find('td.available.holiday').each(function () {
            const rec = holidays.find(h => h.date === moment($(this).data('title'), 'YYYY-MM-DD').format('MM-DD'));
            if (rec) $(this).attr('title', rec.title).tooltip({ placement: 'top' });
          });
        }, 0);
      });

      // Bind events
      $('#apartmentSelect').on('change', updateCounts);
      $('#adultCount, #childCount, #petsCount').on('change', recalc);
      $('#daterange').on('apply.daterangepicker', recalc);

      // Naplnění počtů a omezení podle kapacity
      function updateCounts() {
        const apt = $('#apartmentSelect').val();
        let cap = apt === 'A' ? 11 : apt === 'B' ? 6 : 17;
        let extra = apt === 'A' ? 5 : apt === 'B' ? 2 : 7;
        const totalCap = cap + extra;

        // místo "11+5" teď "Kapacita osob: 16 (11 postelí a 5 přistýlek)"
        $('#capacityDisplay').text(
          ` Max osob: ${totalCap} (${cap} + ${extra})`
        );
        const maxTotal = cap + extra;

        // Dospělí
        const prevAdults = +$('#adultCount').val() || 1;
        $('#adultCount').empty();
        for (let i = 1; i <= maxTotal; i++) $('#adultCount').append(new Option(i, i));
        $('#adultCount').val(Math.min(prevAdults, maxTotal));

        // Děti
        const prevChildren = +$('#childCount').val() || 0;
        $('#childCount').empty();
        for (let i = 0; i <= maxTotal; i++) $('#childCount').append(new Option(i, i));
        $('#childCount').val(Math.min(prevChildren, maxTotal - $('#adultCount').val()));
        // Děti do 2,99 let – max. 10
        const prevToddlers = +$('#toddlerCount').val() || 0;
        $('#toddlerCount').empty();
        for (let i = 0; i <= 10; i++) {
          $('#toddlerCount').append(new Option(i, i));
        }
        $('#toddlerCount').val(Math.min(prevToddlers, 10));
        $('#toddlerCount').off('change').on('change', recalc);

        // Při změně uprav kapacity druhé
        $('#adultCount').off('change').on('change', function () {
          const adults = +this.value;
          const childMax = maxTotal - adults;
          const prevChild = +$('#childCount').val() || 0;
          $('#childCount').empty();
          for (let i = 0; i <= childMax; i++) $('#childCount').append(new Option(i, i));
          $('#childCount').val(Math.min(prevChild, childMax));
          recalc();
        });
        $('#childCount').off('change').on('change', function () {
          const children = +this.value;
          const adultMax = maxTotal - children;
          const prevAdult = +$('#adultCount').val() || 0;
          $('#adultCount').empty();
          for (let i = 0; i <= adultMax; i++) $('#adultCount').append(new Option(i, i));
          $('#adultCount').val(Math.min(prevAdult, adultMax));
          recalc();
        });

        recalc();
      }
     function recalc() {
  const apt = $('#apartmentSelect').val();           // 'A', 'B' nebo 'AB'
  const cap = apt === 'A' ? 11 : apt === 'B' ? 6 : 17;
  const extra = apt === 'A' ? 5  : apt === 'B' ? 2 : 7;

  const adults   = +$('#adultCount').val();
  const children = +$('#childCount').val();
  const toddlers = +$('#toddlerCount').val();
  const pets     = +$('#petsCount').val();

  // celkový počet hostů (bez mazlíčků)
  const ppl = adults + children + toddlers;

  const term  = $('#daterange').val();
  const start = moment(term.split(' - ')[0], 'DD.MM.YYYY');
  const end   = moment(term.split(' - ')[1], 'DD.MM.YYYY');
  const nights = end.diff(start, 'days');

  // funkce na detekci Silvestra: jestli mezi start a end patří noc 31.12.
  let includesSilvester = false;
  for (let d = start.clone(); d.isBefore(end); d.add(1, 'days')) {
    if (d.format('MM-DD') === '12-31') {
      includesSilvester = true;
      break;
    }
  }

  let total = 0;

  if (includesSilvester) {
    // minimální délka pobytu 4 noci
    if (nights < 4) {
      alert('Minimální délka pobytu pro Silvestr je 4 noci. Cena bude spočítána pro 4 noci.');
    }
    const chargeNights = Math.max(nights, 4);

    // nastavení základní ceny podle apartmánu
    let baseRate, includedPeople;
    if (apt === 'A') {
      baseRate       = 7000;
      includedPeople = 10;
    } else if (apt === 'B') {
      baseRate       = 4200;
      includedPeople = 6;
    } else {
      // pro celý objekt Spočítáme jako A+B zvlášť, nebo zadejte vlastní pravidla
      baseRate       = 7000 + 4200;
      includedPeople = 10 + 6;
    }

    // příplatek za každou osobu nad zahrnutý limit
    const extraPeople = Math.max(0, ppl - includedPeople);
    const extraCharge = extraPeople * 700;

    total = chargeNights * (baseRate + extraCharge);

  } else {
    // --- PŮVODNÍ CENOVÁ LOGIKA ---
    // vypočti volné postele
    const emptyBeds = cap - (adults + children);
    for (let d = start.clone(); d.isBefore(end); d.add(1, 'days')) {
      const m  = d.format('MM-DD'),
            wd = d.day(),
            rate = ([5,6].includes(wd) || holidays.includes(m)) ? 650 : 550;
      total += rate * (adults + children + toddlers)
             + pets * 300
             + emptyBeds * 300;
    }
    // 30% příplatek za jednu noc
    if (nights === 1) {
      total = Math.round(total * 1.3);
    }
  }

  // aktualizace rekapitulace
  $('#sumTerm').text(term);
  $('#sumNights').text(nights);
  $('#sumApartment').text(
    apt === 'A' ? 'Apartmán A' :
    apt === 'B' ? 'Apartmán B' :
                   'Celý objekt'
  );
  $('#sumAdults').text(adults);
  $('#sumChildren').text(children);
  $('#sumToddlers').text(toddlers);
  $('#sumPets').text(pets);
  $('#totalPrice').text(total.toLocaleString() + ' CZK');

  // skrytí rekapitulace když není host
  $('.col-lg-5').toggle(ppl > 0);
}


      // Spuštění inicializace
      updateCounts();
    });
  </script>
</body>

</html>